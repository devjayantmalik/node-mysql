# NODE + MYSQL

We will try to learn using `mysql` with nodejs.

## Environment Setup

We require the following requirements:

- Nodejs
- Yarn or NPM
- Internet Connection

## Getting Started

To get started creating our project, here is our basic idea:

- Create a folder `node-mysql`
- Initialize `nodejs` project inside `node-mysql` directory
- Create a `app.js` file to hold our server code.
- Execute sql queries using `app.js` file.
- That's it for now. We will think more about it later.

## Creating a directory for our project.

Let's get started by creating a project directory `node-mysql` on your hard disk.

The command line command to create a directory on linux is:

```sh
mkdir node-mysql
```

To navigate in our project directory, we need to change the current working directory to `node-mysql`. We have a terminal command for it:

```sh
cd node-mysql
```

## Initializing our Project.

Now, we need a nodejs project. We will use **yarn** to initialize a project for us.

```sh
yarn init
```

It will ask you multiple questions just press enter multiple times and you will be good to start.

Another important stuff to remember is to change _entry point filename_ to `app.js`. We will do it inside `package.json` file generated by yarn.

Here is my `package.json` file make sure to change the value of key `main` in your `package.json` file to `app.js` as I did it.

```json
{
  "name": "node-mysql",
  "version": "1.0.0",
  "description": "A application to learn mysql and nodejs",
  "main": "app.js",
  "repository": "https://github.com/devjayantmalik/node-mysql.git",
  "author": "Jayant Malik",
  "license": "MIT",
  "private": false
}
```

## Creating App.js

To proceed further, we need a `app.js` file to act as entry point for our app. This file will create a nodejs server and start it on our machine.

To keep things simple, we will use express as our server. We will install it in next step.

Let's create a file `app.js` inside your project. Touch command helps your create a file in linux.

```sh
touch app.js
```

## Installing Dependencies

Here is a list of dependencies we need to install:

| Dependency Name | Description                                           |
| --------------- | ----------------------------------------------------- |
| mysql           | will allow us to execute sql queries using javascript |
| express         | Helps us create a webserver much easier.              |

To install the above dependencies, execute the following command:

```sh
yarn add mysql express
```

Yarn is a package manager used to install dependencies in your project.

`add` is the option provided provided by yarn to add the dependency in your project requirements. The file holding your project dependencies in `package.json` file.

Till now, you might have also noticed the `node_modules` folder. This folder holds the source code of the dependencies you installed in your project.

## Creating a server

Let's now start working on our app. We will need a webserver, will use express to create it.

The contents of the `app.js` file will look as follows:

```js
// Import Express to create a server
// Import Mysql to create a database connection
const express = require("express");
const mysql = require("mysql");

// Create a server
const server = express();

// Create a database connection
const connection = mysql.createConnection({
  host: "localhost",
  user: "acer",
  password: "password",
});

// Connect to the mysql server
connection.connect((err) => {
  if (err) throw err;

  console.log("Database connected...");
});

// =========================
//  we will create server endpoints here later.
// =========================

// Start the server
const port = 5000;
server.listen(port, () => {
  console.log("Server started at: http://localhost:5000");
});
```

## Testing the server

To test the server and our database connection, we need to execute the `app.js` file using nodejs

The command will do it:

```sh
node app.js
```

If everything is working you will see the message: `Server started at: http://localhost:5000`.

But in my case i got an error:

```sh
Server started at: http://localhost:5000
/home/acer/projects/js/node-mysql/node_modules/mysql/lib/protocol/Parser.js:437
      throw err; // Rethrow non-MySQL errors
      ^

Error: ER_NOT_SUPPORTED_AUTH_MODE: Client does not support authentication protocol requested by server; consider upgrading MySQL client
    at Handshake.Sequence._packetToError (/home/acer/projects/js/node-mysql/node_modules/mysql/lib/protocol/sequences/Sequence.js:47:14)
    at Handshake.ErrorPacket (/home/acer/projects/js/node-mysql/node_modules/mysql/lib/protocol/sequences/Handshake.js:123:18)
    at Protocol._parsePacket (/home/acer/projects/js/node-mysql/node_modules/mysql/lib/protocol/Protocol.js:291:23)
    at Parser._parsePacket (/home/acer/projects/js/node-mysql/node_modules/mysql/lib/protocol/Parser.js:433:10)
    at Parser.write (/home/acer/projects/js/node-mysql/node_modules/mysql/lib/protocol/Parser.js:43:10)
    at Protocol.write (/home/acer/projects/js/node-mysql/node_modules/mysql/lib/protocol/Protocol.js:38:16)
    at Socket.<anonymous> (/home/acer/projects/js/node-mysql/node_modules/mysql/lib/Connection.js:88:28)
    at Socket.<anonymous> (/home/acer/projects/js/node-mysql/node_modules/mysql/lib/Connection.js:526:10)
    at Socket.emit (events.js:314:20)
    at addChunk (_stream_readable.js:303:12)
    --------------------
    at Protocol._enqueue (/home/acer/projects/js/node-mysql/node_modules/mysql/lib/protocol/Protocol.js:144:48)
    at Protocol.handshake (/home/acer/projects/js/node-mysql/node_modules/mysql/lib/protocol/Protocol.js:51:23)
    at Connection.connect (/home/acer/projects/js/node-mysql/node_modules/mysql/lib/Connection.js:116:18)
    at Object.<anonymous> (/home/acer/projects/js/node-mysql/app.js:18:12)
    at Module._compile (internal/modules/cjs/loader.js:1236:30)
    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1257:10)
    at Module.load (internal/modules/cjs/loader.js:1085:32)
    at Function.Module._load (internal/modules/cjs/loader.js:950:14)
    at Function.executeUserEntryPoint [as runMain] (internal/modules/run_main.js:60:12)
    at internal/main/run_main_module.js:17:47 {
  code: 'ER_NOT_SUPPORTED_AUTH_MODE',
  errno: 1251,
  sqlMessage: 'Client does not support authentication protocol requested by server; consider upgrading MySQL client',
  sqlState: '08004',
  fatal: true
}
```

## Fixing the error

The error says that the mysql client we installed as our project dependency is not able to authenticate with the server.

The reason behind it is that our mysql client does not support the authentication protocol used by our database server.

To fix it, the message suggests us to upgrade `mysql` client.

The problem lies in the database server not the mysql client. I want to take a moment to explain, what's happening under the hood.

Whenever we create a new mysql user account, we need to provide the password of the user. Then the mysql encrypts the password and generates a long string of hash that cannot be converted back to password easily.

Now, whenever you try to authenticate the user, the mysql server encrypts the password provided by you and tries to match it with the hash that was generated at the time of signup.

So, after version 8 of mysql, the developers of the mysql changed the password hashing algorithm to `sha2_caching_password`.

Now, by default mysql uses this new password hashing algorithm, unless specified.

And the mysql client we are using in our dependencies does not support this algorithm. So, the issue is occuring. There is a simple fix to this problem.

The solution is to change the authentication algorithm in mysql server for our user (`acer` in my case).

## Solution to the problem

The steps for the solution are:

- Change the user to `root`
- Enter in `mysql` shell
- Execute the query to change the user authentication algorithm.

Here are the commands for it:

```sh
# Switch user to root
su root

# Enter in mysql shell
mysql -u root

# Execute the query in mysql shell
alter user 'acer'@'localhost' identified with mysql_native_password by 'password';
```

## Let's continue to test it again

Now, let's continue with our app.

```sh
node app.js
```

And here is the result.

## Creating Database

Now, we need a database for our app, we have two ways to create the database, one way would to use mysql shell or mysql workbench and the other way would be to do it using our app.

Please note that, we will not create database with our app, in production. Because, this will lead to security issue in our app. Usually we have seperate user that could create database and our app does not have permission to create the database, when running in production. Our app only reads database in case of production.

But, for now I want to show you both ways of doing it, For a developer it is important to understand both the ways.

## Creating Database using our app.

Here is the source code of `app.js` file that executes the query using mysql connection and creates a database.

```js
// Create a database
connection.query(
  "CREATE DATABASE IF NOT EXISTS node_mysql;",
  (err, results) => {
    if (err) throw err;

    console.log("Database created...");
  }
);
```

And here is the complete `app.js` file :

```js
// Import Express to create a server
// Import Mysql to create a database connection
const express = require("express");
const mysql = require("mysql");

// Create a server
const server = express();

// Create a database connection
const connection = mysql.createConnection({
  host: "localhost",
  user: "test",
  password: "password",
});

// Connect to the mysql server
connection.connect((err) => {
  if (err) throw err;

  console.log("Database connected...");
});

// Create a database
connection.query(
  "CREATE DATABASE IF NOT EXISTS node_mysql;",
  (err, results) => {
    if (err) throw err;

    console.log("Database created...");
  }
);

// =========================
//  we will create server endpoints here later.
// =========================

// Start the server
const port = 5000;
server.listen(port, () => {
  console.log("Server started at: http://localhost:5000");
});
```

Now, you need to restart the nodejs server to see the changes.

To restart the server, press <kbd>Ctrl + C</kbd> to cancel the current process of nodejs. And then type the command `node app.js` to start it again.

## Creating Tables

After creating database, we need tables to store our posts data. And to create our posts table, we need to have a list of columns in our post table.

Here is a list of columns:
| Column Name | Description |
| ---------- | --------- |
| id | Stores a unique key, identifying a row. (Primary Key) |
| title | Stores title of the post|
| author_name | Stores name of the author who created the post|
| content | Stores post html contents |
| created_at | Stores the date of creation of the post|
| updated_at | Stores the date of updation of the post |

Now, we have a list of columns of our post table, let's continue to write a mysql query that creates `posts` table.

Here is the `app.js` source code that creates the posts table.

```js
// Create a posts table.
const query = `
CREATE TABLE IF NOT EXISTS posts(
    id INTEGER PRIMARY KEY NOT NULL AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL UNIQUE,
    author_name VARCHAR(100) NOT NULL DEFAULT 'anonymous',
    content TEXT DEFAULT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
  );`;

connection.query(query, (err, result) => {
  if (err) throw err;

  console.log("Table created successfully.");
});
```

Here is the complete `app.js` file for now.

```js
// Import Express to create a server
// Import Mysql to create a database connection
const express = require("express");
const mysql = require("mysql");

// Create a server
const server = express();

// Create a database connection
const connection = mysql.createConnection({
  host: "localhost",
  user: "test",
  password: "password",
});

// Connect to the mysql server
connection.connect((err) => {
  if (err) throw err;

  console.log("Database connected...");
});

// Create a database
connection.query(
  "CREATE DATABASE IF NOT EXISTS node_mysql;",
  (err, results) => {
    if (err) throw err;

    console.log("Database created...");
  }
);

// Create a posts table.
const query = `
CREATE TABLE IF NOT EXISTS posts(
    id INTEGER PRIMARY KEY NOT NULL AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL UNIQUE,
    author_name VARCHAR(100) NOT NULL DEFAULT 'anonymous',
    content TEXT DEFAULT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
  );`;

connection.query(query, (err, result) => {
  if (err) throw err;

  console.log("Table created successfully.");
});

// =========================
//  we will create server endpoints here later.
// =========================

// Start the server
const port = 5000;
server.listen(port, () => {
  console.log("Server started at: http://localhost:5000");
});
```

Now, let's test that it works. Restart the server and check to see if you get any error.

And I my case I got the following error:

```sh
Server started at: http://localhost:5000
Database connected...
Database created...
/home/acer/projects/js/node-mysql/node_modules/mysql/lib/protocol/Parser.js:437
      throw err; // Rethrow non-MySQL errors
      ^

Error: ER_NO_DB_ERROR: No database selected
    # Some content here .....
    --------------------
    at internal/main/run_main_module.js:17:47 {
  code: 'ER_NO_DB_ERROR',
  errno: 1046,
  sqlMessage: 'No database selected',
  sqlState: '3D000',
  index: 0,
  sql: '\n' +
    'CREATE TABLE IF NOT EXISTS posts(\n' +
    '    id INTEGER PRIMARY KEY NOT NULL AUTO_INCREMENT,\n' +
    '    title VARCHAR(200) NOT NULL UNIQUE,\n' +
    "    author_name VARCHAR(100) NOT NULL DEFAULT 'anonymous',\n" +
    '    content TEXT DEFAULT NULL,\n' +
    '    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n' +
    '    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP\n' +
    '  );'
}

```

The error specifies that no database was selected. Let's fix it in next step

## Fixing No database selected

There are two ways to fix this problem.

First solution is:

You execute a mysql statement that marks the database as current selected database.

```sql
USE node_mysql;
```

Second solution is:

You provide the database name to mysql connection and it executes the above query for you.

Let's use second solution in our case.

Here is the connection object at the top of `app.js` file

```js
// Create a database connection
const connection = mysql.createConnection({
  host: "localhost",
  user: "test",
  password: "password",
  database: "node_mysql",
});
```

And now, if you restart the server everything should work fine.

## Operations on the Table.

We now have our database and our table setup.

Next step would be to perform operations on the table, such as :

- Reading data from table
- Writing data to the table
- Updating data to the table
- Deleting data from the table

Will will implement these operations in next step

## Reading Data

Let's work on `app.js` file, and we will configure our server to handle request.

Here is my idea:

- Fetch data using mysql
- Return data as json in response
- View the data by opening the url in webbrowser

Let's get started here is the code for `app.js` file:

```js
// Get data from the server
connection.query("SELECT * FROM posts", (err, result) => {
  if (err) throw err;

  console.log(result);
});
```

Now, let's test it out. Restart the server and you will see an empty array. That's because we don't have any data in our table.

Let's add data to our table, It is really simple, because you need to execute sql query for every task you do and that's it. So, I will provide you source code for all operations.

## Complete Source Code

```js
// Import Express to create a server
// Import Mysql to create a database connection
const express = require("express");
const mysql = require("mysql");

// Create a server
const server = express();

// Create a database connection
const connection = mysql.createConnection({
  host: "localhost",
  user: "test",
  password: "password",
  database: "node_mysql",
});

// Connect to the mysql server
connection.connect((err) => {
  if (err) throw err;

  console.log("Database connected...");
});

// Create a database
connection.query(
  "CREATE DATABASE IF NOT EXISTS node_mysql;",
  (err, results) => {
    if (err) throw err;

    console.log("Database created...");
  }
);

// Create a posts table.
const query = `
CREATE TABLE IF NOT EXISTS posts(
    id INTEGER PRIMARY KEY NOT NULL AUTO_INCREMENT,
    title VARCHAR(200) NOT NULL UNIQUE,
    author_name VARCHAR(100) NOT NULL DEFAULT 'anonymous',
    content TEXT DEFAULT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
  );`;

connection.query(query, (err, result) => {
  if (err) throw err;

  console.log("Table created successfully.");
});

// Get data from the server
connection.query("SELECT * FROM posts", (err, result) => {
  if (err) throw err;

  console.log(result);
});

// Insert data in the server
const post = {
  title: "Post 2",
  author_name: "Author 2",
  content: "This is post content",
};

connection.query("INSERT INTO posts SET ?;", post, (err, result) => {
  if (err) throw err;

  console.log(result);
});

// Update into Posts
const post2 = {
  content: "This is updated post content",
};

connection.query("UPDATE posts SET ? WHERE id=2;", post2, (err, result) => {
  if (err) throw err;

  console.log(result);
});

// Delete posts
connection.query("DELETE FROM posts WHERE id=1;", (err, result) => {
  if (err) throw err;

  console.log(result);
});

// Start the server
const port = 5000;
server.listen(port, () => {
  console.log("Server started at: http://localhost:5000");
});
```

And finally, I realised there is no need to create a server, I just needed to import mysql and perform operations, server would be used when I wanted to send the data as response to user.

Thanks I think the Code works great.
